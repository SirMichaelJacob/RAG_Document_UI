@{
    ViewData["Title"] = "AI Document Assistant";
}

<div class="container-fluid py-4">
    <div class="row g-4">

        <!-- ============== INGESTION ============== -->
        <div class="col-lg-4">
            <div class="card shadow-lg h-100 border-0">
                <div class="card-body d-flex flex-column">
                    <h5 class="fw-bold mb-3">📄 Add Document</h5>
                    <textarea id="docText" class="form-control flex-grow-1"
                              placeholder="Paste document text..."></textarea>
                    <button id="btnUpload" class="btn btn-primary mt-3">
                        Upload Document
                    </button>
                </div>
            </div>
        </div>

        <!-- ============== CHAT ============== -->
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 chat-card">
                <div class="card-body d-flex flex-column p-0">

                    <div class="chat-header p-3 border-bottom d-flex justify-content-between">
                        <h5 class="fw-bold mb-0">🤖 AI Document Assistant</h5>
                        <button id="btnClearChat" class="btn btn-sm btn-outline-secondary">
                            Clear Chat
                        </button>
                    </div>

                    <div id="chat" class="chat-messages p-4"></div>

                    <div class="chat-input p-3 border-top bg-white">
                        <div class="input-group">
                            <input id="question" class="form-control"
                                   placeholder="Ask something about your documents..." />
                            <button id="btnAsk" class="btn btn-success">Ask</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<!-- ============== MODALS ============== -->
<!-- Upload Confirmation Modal -->
<div class="modal fade" id="confirmUploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Upload</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to upload this document to the AI system?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmUploadBtn" class="btn btn-primary">Yes, Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Chat Confirmation Modal -->
<div class="modal fade" id="confirmClearModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Clear Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                This will remove all messages from the chat. Continue?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmClearBtn" class="btn btn-danger">Clear Chat</button>
            </div>
        </div>
    </div>
</div>

<!-- ============== TOAST ============== -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2100">
    <div id="appToast" class="toast border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMsg"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- ============== LOADING ============== -->
<div id="loadingOverlay" class="d-none">
    <div class="spinner-border text-primary"></div>
</div>



@section Scripts {
    <script>
        const overlay = $('#loadingOverlay');
        const uploadModal = new bootstrap.Modal('#confirmUploadModal');
        const clearModal = new bootstrap.Modal('#confirmClearModal');

        function showLoading(){ overlay.removeClass('d-none'); }
        function hideLoading(){ overlay.addClass('d-none'); }

        function notify(msg, ok=true){
            const toastEl = document.getElementById('appToast');
            toastEl.classList.remove('text-bg-success','text-bg-danger');
            toastEl.classList.add(ok?'text-bg-success':'text-bg-danger');
            $('#toastMsg').text(msg);
            bootstrap.Toast.getOrCreateInstance(toastEl,{delay:3000}).show();
        }

        function append(sender,text){
            const c = sender==='You'?'user':'ai';
            $('#chat').append(`<div class="chat-bubble ${c}">
                <strong>${sender}</strong><pre>${escapeHtml(text)}</pre></div>`);
            $('#chat').scrollTop($('#chat')[0].scrollHeight);
        }

        function escapeHtml(t){ return $('<div/>').text(t).html(); }

        /* Upload Flow */
        $('#btnUpload').click(()=>uploadModal.show());

        $('#confirmUploadBtn').click(function(){
            const content=$('#docText').val().trim();
            if(!content){ notify("Document is empty",false); return;}

            uploadModal.hide();
            showLoading();

            $.ajax({
            url: '/AiDocuments/AddDocument',
            type: 'POST',
            data: { content: content },
            dataType: 'json',              // 👈 tells jQuery to expect JSON
            success: function (res) {
                if (res.isSuccess) {
                    notify("Document uploaded");
                    $('#docText').val('');
                } else {
                    notify(res.message, false);
                }
            },
            error: function () {
                notify("Upload failed", false);
            },
            complete: function () {
                hideLoading();
            }
        });

        });

        /* Clear Chat */
        $('#btnClearChat').click(()=>clearModal.show());
        $('#confirmClearBtn').click(()=>{
            $('#chat').empty();
            clearModal.hide();
            notify("Conversation cleared");
        });

        /* Ask */
        $('#btnAsk').click(function(){
            const q=$('#question').val().trim();
            if(!q) return;
            append('You',q);
            $('#question').val('');
            showLoading();
            $.post('/AiDocuments/Query',{question:q})
             .done(ans=>append('AI Assistant',ans))
             .fail(()=>append('System','Error querying documents'))
             .always(()=>hideLoading());
        });
    </script>
}
